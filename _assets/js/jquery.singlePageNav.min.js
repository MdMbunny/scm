/**
 * Single Page Nav Plugin
 * Copyright (c) 2013 Chris Wojcik <hello@chriswojcik.net>
 * Copyright (c) 2015 SCM <info@mdmbunny.com>
 * Dual licensed under MIT and GPL.
 * @author SCM after Chris Wojcik
 * @version 2.0.0
 */

// Utility
if( typeof Object.create !== 'function' ) {
    Object.create = function( obj ) {
        function F() {}
        F.prototype = obj;
        return new F();
    };
}

(function( $, window, document, undefined ) {
    "use strict";
    
    var SinglePageNav = {
        
        init: function( options, container ) {

            var self = this;

            self.container = container;            
            self.$container = $(container);
            self.$window = $( window );
            self.$body = $( 'body' );
            
            self.options = $.extend( {}, $.fn.singlePageNav.defaults, options );
            
            self.options.currentClass = ( self.$container.data( 'single-class' ) ? self.$container.data( 'single-class' ) : self.options.currentClass ),
            self.options.offset = ( self.$container.data( 'single-offset' ) ? self.$container.data( 'single-offset' ) : self.options.offset ),
            self.options.threshold = ( self.$container.data( 'single-threshold' ) ? self.$container.data( 'single-threshold' ) : self.options.threshold ),
            self.options.interval = ( self.$container.data( 'single-interval' ) ? self.$container.data( 'single-interval' ) : self.options.interval );

            self.$links = [];
            self.$hash = [];
            self.$anchors = [];

            if( !self.options.fromData )
                self.$links = self.$body.find( 'a[href^="#"]' );
            else
                self.$links = self.$body.find( '[data-anchor]' );

            if ( self.options.filter !== '' )
                self.$links = self.$links.filter( self.options.filter );

            if( !self.$links.length )
                return;

            self.$links.each( function(){
                var hash, $anchors;
                if( !self.options.fromData ){
                    hash = this.hash;
                }else{
                    hash = $( this ).data( 'anchor' );
                    
                }
                $anchors = self.$container.find( hash );

                if( $anchors.length ){
                    self.$anchors.push( $anchors );
                    self.$hash.push( $( this ) );
                }

            } );

            self.didScroll = true;
            self.setTimer();
        },
        
        setTimer: function() {
            var self = this;
            
            self.$window.on( 'scroll.singlePageNav', function() {
                self.didScroll = true;
            });
            
            self.checkPosition();
            self.timer = setInterval( function() {

                if ( self.didScroll ) {

                    self.didScroll = false;
                    self.checkPosition();

                }

            }, this.options.interval );
        },
        
        clearTimer: function() {
            var self = this;

            clearInterval( self.timer );
            self.$window.off( 'scroll.singlePageNav' );
            self.didScroll = false;

        },

        checkPosition: function() {

            var self = this;

            var scrollPos = self.$window.scrollTop();
            self.setActiveClass( scrollPos );

        },
        
        setActiveClass: function( scrollPos ) {
            var coords, elem;

            var self = this;

            for( var i = 0; i < self.$anchors.length; i++ ) {

                var $anchor = self.$anchors[i];

                coords = {
                    top: Math.round( $anchor.offset().top ) - self.options.offset,
                    bottom: Math.round( $anchor.offset().top + $anchor.outerHeight() ) - self.options.offset
                };

                elem = $( self.$hash[i] ).parent();
                
                if ( scrollPos >= coords.top - self.options.threshold && scrollPos < coords.bottom - self.options.threshold ) {
                    $( elem ).addClass( self.options.currentClass );
                }else{
                    $( elem ).removeClass( self.options.currentClass );
                }

            }

            if ( scrollPos + self.$window.height() >= self.$body.outerHeight() ) {

                elem = $( self.$hash[self.$hash.length-1] ).parent();
                $( self.$hash ).each( function(){
                    $( this ).parent().removeClass( self.options.currentClass );
                });
                $( elem ).addClass( self.options.currentClass );

            }


        }
    };
    
    $.fn.singlePageNav = function( options ) {
        return this.each(function() {
            var singlePageNav = Object.create( SinglePageNav );
            singlePageNav.init( options, this );
        });
    };
    
    $.fn.singlePageNav.defaults = {
        fromData: 0,
        offset: 0,
        threshold: 0,
        currentClass: 'current',
        filter: '',
        interval: 0,
    };
    
})( jQuery, window, document );